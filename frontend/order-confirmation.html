<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Confirmation - Pizza Shop</title>
  <script>
    function logout(){
      try {
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('password');
      } catch(_) {}
      window.location = '/login?logout=1';
    }

    async function ensureAuthAndSetupNav(){
      const u = sessionStorage.getItem('username');
      const p = sessionStorage.getItem('password');
      if (!u || !p) { 
        window.location = '/login'; 
        return; 
      }
      document.getElementById('connected_as').textContent = 'Connected as: ' + u + '.';
      try {
        const r = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p}) });
        const data = await r.json();
        if (!data.ok) { 
          window.location = '/login'; 
          return; 
        }
        if (data.isAdmin) {
          const adminLink = document.getElementById('admin-link');
          if (adminLink) adminLink.style.display = 'inline-block';
        }
      } catch (e) {
        // If the check fails, we silently keep user on page
      }
      updateCartCount();
    }

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('pizzaCart') || '[]');
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartLink = document.getElementById('cart-link');
      if (cartLink) {
        cartLink.textContent = 'Cart (' + count + ')';
      }
    }

    async function loadOrderDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const orderID = urlParams.get('order_id');
      
      if (!orderID) {
        document.getElementById('order-details').innerHTML = '<p>No order ID provided.</p>';
        return;
      }

      const username = sessionStorage.getItem('username');
      const password = sessionStorage.getItem('password');

      try {
        const response = await fetch('/order/details', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            password: password,
            order_id: parseInt(orderID)
          })
        });

        const data = await response.json();

        if (data.ok) {
          displayOrderDetails(data.order);
        } else {
          document.getElementById('order-details').innerHTML = '<p>Error loading order: ' + (data.error || 'Unknown error') + '</p>';
        }
      } catch (err) {
        document.getElementById('order-details').innerHTML = '<p>Error loading order details: ' + err.message + '</p>';
      }
    }

    function displayOrderDetails(orderDetails) {
      const container = document.getElementById('order-details');
      
      const order = orderDetails.order;
      const pizzas = orderDetails.pizzas || [];
      const extraItems = orderDetails.extra_items || [];
      
      let html = '<h2>Order #' + order.id + '</h2>';
      html += '<p><b>Customer:</b> ' + order.customer_name + '</p>';
      html += '<p><b>Status:</b> ' + order.status + '</p>';
      html += '<p><b>Order Time:</b> ' + new Date(order.timestamp).toLocaleString('en-US', { 
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false 
      }) + '</p>';
      html += '<p><b>Delivery Address:</b> ' + order.delivery_address + '</p>';
      html += '<p><b>Postal Code:</b> ' + order.postal_code + '</p>';
      html += '<hr width="70%">';
      
      html += '<h3>Items Ordered</h3>';
      html += '<table border="1" cellpadding="8" cellspacing="0" width="70%">';
      html += '<thead>';
      html += '<tr><th>Item</th><th>Quantity</th><th>Price</th></tr>';
      html += '</thead>';
      html += '<tbody>';
      
      // Display pizzas
      pizzas.forEach((pizza, index) => {
        html += '<tr>';
        html += '<td><b>' + pizza.pizza_name + '</b></td>';
        html += '<td align="center">' + pizza.quantity + '</td>';
        html += '<td align="right">-</td>';
        html += '</tr>';
      });
      
      // Display extra items (desserts and drinks)
      extraItems.forEach((extra, index) => {
        html += '<tr>';
        html += '<td><b>' + extra.extra_item_name + '</b></td>';
        html += '<td align="center">' + extra.quantity + '</td>';
        html += '<td align="right">$' + (extra.price * extra.quantity).toFixed(2) + '</td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      html += '<br>';
      html += '<h3>Total Price: $' + orderDetails.total_price.toFixed(2) + '</h3>';
      
      container.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', () => {
      ensureAuthAndSetupNav();
      loadOrderDetails();
    });
  </script>
</head>
<body>
  <center>
    <nav>
      <a href="/home">Home</a> |
      <a href="/account">Account</a> |
      <a id="admin-link" href="/admin" style="display:none;">Admin</a>
      <a id="cart-link" href="/cart">Cart (0)</a> |
      <a href="#" onclick="logout(); return false;">Logout</a>
    </nav>
    <hr>
    
    <h1>Order Confirmation</h1>
    <p id="connected_as"><i>Connected as: ?</i></p>
    
    <p><b>Your order has been placed successfully!</b></p>
    
    <div id="order-details">
      <p>Loading order details...</p>
    </div>
    
    <br>
    <a href="/home"><button>Back to Home</button></a>
  </center>
</body>
</html>
