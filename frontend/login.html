<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Pizza Shop</title>
</head>
<body>
  <center>
    <h1>Welcome to Pizza Shop</h1>
    <p><i>Please login to continue</i></p>
    <hr>

    <h2>Login</h2>
    <form>
      <table>
        <tr>
          <td><b>Username:</b></td>
        </tr>
        <tr>
          <td><input type="text" id="username" name="username" required></td>
        </tr>
        <tr>
          <td><b>Password:</b></td>
        </tr>
        <tr>
          <td><input type="password" id="password" name="password" required></td>
        </tr>
        <tr>
          <td><button type="submit" onclick="login(event)">Login</button></td>
        </tr>
      </table>
    </form>

    <p id="error"></p>

    <p>No account? <a href="/register">Register here</a></p>
  </center>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        if (params.has("logout")) {
            try {
                sessionStorage.removeItem("username");
                sessionStorage.removeItem("password");
            } catch (e) {
                //ignore
            }

            const msgEl = document.getElementById("error");
            if (msgEl) {
                alert("You have been logged out.");
                msgEl.innerText = "You have been logged out.";}
            
            const url = new URL(window.location.href);
            url.searchParams.delete("logout");
            window.history.replaceState({}, "", url.pathname + (url.search ? ("?" + url.searchParams.toString()) : ""));
        }
    });

    function logout() {
        try {
            sessionStorage.removeItem("username");
            sessionStorage.removeItem("password");
        } catch (e) {
            //ignore
        }
        window.location = "/login";
    }

    function prepare(){
    }
    function login(event){
        event.preventDefault();

        var usernameInput = document.getElementById("username");
        var passwordInput = document.getElementById("password");

        var sendData = {
            username: usernameInput.value,
            password: passwordInput.value,
        };

        fetch("/login", {
            method: "POST",
            headers: {
            "Content-Type": "application/json"
            },
            body: JSON.stringify(sendData)
        })
            .then(response => response.json())
            .then(data =>{
                if (data.ok){
                    sessionStorage.setItem("username", usernameInput.value);
                    sessionStorage.setItem("password", passwordInput.value);
                    if (data.role == "ADMIN"){
                        window.location = "/admin";
                    } 
                    else if (data.role == "DELIVERY"){
                        window.location = "/delivery_person";
                    }
                    else if (data.role == "CUSTOMER"){
                        window.location = "/home";
                    }
                }
                else{
                    var errorText = document.getElementById("error");
                    errorText.innerHTML = data.msg;
                }
            });
    }
</script>
</body>
</html>