<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
</head>
<body>
  <center>
    <h1>Admin Panel</h1>
    <p><a href="/home">Home</a> | <a href="/login?logout=1">Log out</a></p>
    <hr>

  <input id="adm-user" type="hidden" value="admin" />
  <input id="adm-pass" type="hidden" value="admin" />

  <p>
    <button onclick="showTab('users')">Users</button>
    <button onclick="showTab('orders')">Orders</button>
    <button onclick="showTab('delivery')">Delivery Persons</button>
    <button onclick="showTab('pizzas')">Pizzas</button>
    <button onclick="showTab('ingredients')">Ingredients</button>
  </p>

  <!-- Users Tab -->
  <div id="users-tab">
    <h2>User Management</h2>
    
    <button onclick="loadUsers()">Refresh Users List</button>
    <div id="users-list"></div>
    
    <h3>Create New Customer</h3>
    <table>
      <tr><td><b>Username:</b></td></tr>
      <tr><td><input id="new-user-username" type="text" /></td></tr>
      <tr><td><b>Password:</b></td></tr>
      <tr><td><input id="new-user-password" type="password" /></td></tr>
      <tr><td><b>Name:</b></td></tr>
      <tr><td><input id="new-user-name" type="text" /></td></tr>
      <tr><td><b>Gender:</b></td></tr>
      <tr><td><input id="new-user-gender" type="text" /></td></tr>
      <tr><td><b>Birth Date:</b></td></tr>
      <tr><td><input id="new-user-birthdate" type="date" /></td></tr>
      <tr><td><input id="new-user-no-birthdate" type="checkbox" /> No birth date</td></tr>
      <tr><td><b>Address:</b></td></tr>
      <tr><td><input id="new-user-address" type="text" /></td></tr>
      <tr><td><b>Postal Code:</b></td></tr>
      <tr><td><input id="new-user-postal" type="text" /></td></tr>
    </table>
    
    <button onclick="createCustomer()">Create Customer</button>
  </div>

  <!-- Orders Tab -->
  <div id="orders-tab" style="display:none;">
    <h2>Order Management</h2>
    
    <button onclick="loadOrders()">Refresh Orders List</button>
    <div id="orders-list"></div>
  </div>

  <!-- Delivery Persons Tab -->
  <div id="delivery-tab" style="display:none;">
    <h2>Delivery Person Management</h2>
    
    <button onclick="loadDeliveryPersons()">Refresh Delivery Persons List</button>
    <div id="delivery-list"></div>
    
    <h3>Create Delivery Person</h3>
    <table>
      <tr><td><b>Username:</b></td></tr>
      <tr><td><input id="new-delivery-username" type="text" /></td></tr>
      <tr><td><b>Password:</b></td></tr>
      <tr><td><input id="new-delivery-password" type="password" /></td></tr>
      <tr><td><b>Name:</b></td></tr>
      <tr><td><input id="new-delivery-name" type="text" /></td></tr>
    </table>
    
    <button onclick="createDeliveryPerson()">Create Delivery Person</button>
  </div>

  <!-- Pizzas Tab -->
  <div id="pizzas-tab" style="display:none;">
    <h2>Pizzas</h2>
    <button onclick="listPizzas()">List pizzas</button>
    <pre id="pizzas-list"></pre>
    
    <h3>Create pizza</h3>
    <table>
      <tr><td>Pizza name:</td></tr>
      <tr><td><input id="pizza-name" /></td></tr>
      <tr><td>Ingredients (comma separated):</td></tr>
      <tr><td><input id="pizza-ingredients" /></td></tr>
    </table>
    <button onclick="createPizza()">Create</button>
    
    <h3>Delete pizza</h3>
    <input id="pizza-del-id" type="number" placeholder="Pizza ID" />
    <button onclick="deletePizza()">Delete</button>
  </div>

  <!-- Ingredients Tab -->
  <div id="ingredients-tab" style="display:none;">
    <h2>Ingredients</h2>
    <button onclick="listIngredients()">List ingredients</button>
    <pre id="ingredients-list"></pre>
    
    <h3>Create ingredient</h3>
    <table>
      <tr><td>Name:</td></tr>
      <tr><td><input id="ingr-name" /></td></tr>
      <tr><td>Cost (cents):</td></tr>
      <tr><td><input id="ingr-cost" type="number" /></td></tr>
      <tr><td><input id="ingr-meat" type="checkbox" /> Has meat</td></tr>
      <tr><td><input id="ingr-animal" type="checkbox" /> Has animal products</td></tr>
    </table>
    <button onclick="createIngredient()">Create</button>
    
    <h3>Delete ingredient</h3>
    <input id="ingr-del-id" type="number" placeholder="Ingredient ID" />
    <button onclick="deleteIngredient()">Delete</button>
  </div>

  <script>
    function creds() {
      return {
        u: document.getElementById('adm-user').value,
        p: document.getElementById('adm-pass').value,
      };
    }

    function showTab(tabName) {
      // Hide all tabs
      document.getElementById('users-tab').style.display = 'none';
      document.getElementById('orders-tab').style.display = 'none';
      document.getElementById('delivery-tab').style.display = 'none';
      document.getElementById('pizzas-tab').style.display = 'none';
      document.getElementById('ingredients-tab').style.display = 'none';
      
      // Show selected tab
      document.getElementById(tabName + '-tab').style.display = 'block';
      
      // Auto-load data for the tab
      if (tabName === 'users') loadUsers();
      if (tabName === 'orders') loadOrders();
      if (tabName === 'delivery') loadDeliveryPersons();
    }

    function loadUsers() {
      fetch('/admin/users/list')
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            if (data.users && data.users.length > 0) {
              displayUsers(data.users);
            } else {
              document.getElementById('users-list').innerHTML = '<p>No non-admin users found. Create some customers or delivery persons!</p>';
            }
          } else {
            document.getElementById('users-list').innerHTML = '<p>Error: ' + (data.error || 'Unknown error') + '</p>';
          }
        })
        .catch(err => {
          document.getElementById('users-list').innerHTML = '<p>Error loading users: ' + err.message + '</p>';
        });
    }

    function displayUsers(users) {
      const container = document.getElementById('users-list');
      if (users.length === 0) {
        container.innerHTML = '<p>No users found.</p>';
        return;
      }
      
      let html = '<center><table border="1"><tr><th>ID</th><th>Username</th><th>Role</th><th>Name</th><th>Gender</th><th>Address</th><th>Actions</th></tr>';
      users.forEach(user => {
        html += `<tr>
          <td>${user.id}</td>
          <td>${user.username}</td>
          <td>${user.role}</td>
          <td>${user.name}</td>
          <td>${user.gender}</td>
          <td>${user.address}</td>
          <td>
            <button onclick="deleteUser(${user.id}, '${user.username}')">Delete</button>
          </td>
        </tr>`;
      });
      html += '</table></center>';
      container.innerHTML = html;
    }

    function createCustomer() {
      const {u, p} = creds();
      
      const body = {
        admin_username: u,
        admin_password: p,
        user_type: 'customer',
        username: document.getElementById('new-user-username').value,
        password: document.getElementById('new-user-password').value,
        name: document.getElementById('new-user-name').value,
        gender: document.getElementById('new-user-gender').value,
        birth_date: document.getElementById('new-user-birthdate').value,
        no_birth_date: document.getElementById('new-user-no-birthdate').checked,
        address: document.getElementById('new-user-address').value,
        postal_code: document.getElementById('new-user-postal').value,
      };
      
      fetch('/admin/users/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            alert('Customer created successfully!');
            loadUsers();
            document.getElementById('new-user-username').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-gender').value = '';
            document.getElementById('new-user-birthdate').value = '';
            document.getElementById('new-user-no-birthdate').checked = false;
            document.getElementById('new-user-address').value = '';
            document.getElementById('new-user-postal').value = '';
          } else {
            alert('Error: ' + (data.message || data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          alert('Error creating customer: ' + err.message);
        });
    }

    function createDeliveryPerson() {
      const {u, p} = creds();
      
      const body = {
        admin_username: u,
        admin_password: p,
        user_type: 'delivery',
        username: document.getElementById('new-delivery-username').value,
        password: document.getElementById('new-delivery-password').value,
        name: document.getElementById('new-delivery-name').value,
      };
      
      fetch('/admin/users/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            alert('Delivery person created successfully!');
            loadDeliveryPersons();
            document.getElementById('new-delivery-username').value = '';
            document.getElementById('new-delivery-password').value = '';
            document.getElementById('new-delivery-name').value = '';
          } else {
            alert('Error: ' + (data.message || data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          alert('Error creating delivery person: ' + err.message);
        });
    }

    function deleteUser(id, username) {
      if (!confirm(`Are you sure you want to delete user "${username}"? This will also delete all their orders.`)) return;
      
      const {u, p} = creds();
      fetch('/admin/users/delete?id=' + id, {
        method: 'DELETE',
        headers: {'X-Username': u, 'X-Password': p}
      })
        .then(r => {
          if (r.ok) {
            alert('User deleted successfully!');
            loadUsers();
          } else {
            return r.text().then(text => { throw new Error(text); });
          }
        })
        .catch(err => {
          alert('Error deleting user: ' + err.message);
        });
    }

    // Orders Management
    function loadOrders() {
      fetch('/admin/orders/list')
        .then(r => r.json())
        .then(data => {
          if (data.ok && data.orders) {
            displayOrders(data.orders);
          } else {
            document.getElementById('orders-list').innerHTML = '<p>No orders found.</p>';
          }
        })
        .catch(err => {
          document.getElementById('orders-list').innerHTML = '<p>Error loading orders.</p>';
          console.error(err);
        });
    }

    function displayOrders(orders) {
      const container = document.getElementById('orders-list');
      if (orders.length === 0) {
        container.innerHTML = '<p>No orders found.</p>';
        return;
      }
      
      let html = '<center><table border="1"><tr><th>ID</th><th>Customer</th><th>Date</th><th>Status</th><th>Address</th><th>Postal Code</th><th>Actions</th></tr>';
      orders.forEach(order => {
        const date = new Date(order.timestamp).toLocaleString();
        html += `<tr>
          <td>${order.id}</td>
          <td>${order.customer_name}</td>
          <td>${date}</td>
          <td>
            <select onchange="updateOrderStatus(${order.id}, this.value)">
              <option value="IN_PROGRESS" ${order.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
              <option value="DELIVERED" ${order.status === 'DELIVERED' ? 'selected' : ''}>Delivered</option>
              <option value="FAILED" ${order.status === 'FAILED' ? 'selected' : ''}>Failed</option>
            </select>
          </td>
          <td>${order.delivery_address}</td>
          <td>${order.postal_code}</td>
          <td>
            <button onclick="viewOrderDetails(${order.id})">View</button>
            <button onclick="deleteOrder(${order.id})">Delete</button>
          </td>
        </tr>`;
      });
      html += '</table></center>';
      container.innerHTML = html;
    }

    function updateOrderStatus(orderId, status) {
      const {u, p} = creds();
      fetch('/admin/orders/update-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          admin_username: u,
          admin_password: p,
          order_id: orderId,
          status: status
        })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            alert('Order status updated!');
            loadOrders();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(err => {
          alert('Error updating order: ' + err.message);
        });
    }

    function viewOrderDetails(orderId) {
      window.open(`/order-confirmation?order_id=${orderId}`, '_blank');
    }

    function deleteOrder(id) {
      if (!confirm(`Are you sure you want to delete order #${id}?`)) return;
      
      const {u, p} = creds();
      fetch('/admin/orders/delete?id=' + id, {
        method: 'DELETE',
        headers: {'X-Username': u, 'X-Password': p}
      })
        .then(r => {
          if (r.ok) {
            alert('Order deleted successfully!');
            loadOrders();
          } else {
            return r.text().then(text => { throw new Error(text); });
          }
        })
        .catch(err => {
          alert('Error deleting order: ' + err.message);
        });
    }

    // Delivery Persons Management
    function loadDeliveryPersons() {
      fetch('/admin/delivery/list')
        .then(r => r.json())
        .then(data => {
          if (data.ok && data.delivery_persons) {
            displayDeliveryPersons(data.delivery_persons);
          } else {
            document.getElementById('delivery-list').innerHTML = '<p>No delivery persons found.</p>';
          }
        })
        .catch(err => {
          document.getElementById('delivery-list').innerHTML = '<p>Error loading delivery persons.</p>';
          console.error(err);
        });
    }

    function displayDeliveryPersons(persons) {
      const container = document.getElementById('delivery-list');
      if (persons.length === 0) {
        container.innerHTML = '<p>No delivery persons found.</p>';
        return;
      }
      
      let html = '<center><table border="1"><tr><th>ID</th><th>Username</th><th>Name</th><th>Actions</th></tr>';
      persons.forEach(person => {
        html += `<tr>
          <td>${person.id}</td>
          <td>${person.username}</td>
          <td>${person.name}</td>
          <td>
            <button onclick="deleteDeliveryPerson(${person.id}, '${person.name}')">Delete</button>
          </td>
        </tr>`;
      });
      html += '</table></center>';
      container.innerHTML = html;
    }

    function deleteDeliveryPerson(id, name) {
      if (!confirm(`Are you sure you want to delete delivery person "${name}"?`)) return;
      
      const {u, p} = creds();
      fetch('/admin/delivery/delete?id=' + id, {
        method: 'DELETE',
        headers: {'X-Username': u, 'X-Password': p}
      })
        .then(r => {
          if (r.ok) {
            alert('Delivery person deleted successfully!');
            loadDeliveryPersons();
          } else {
            return r.text().then(text => { throw new Error(text); });
          }
        })
        .catch(err => {
          alert('Error deleting delivery person: ' + err.message);
        });
    }

    // Ingredients Management (existing code)
    function listIngredients(){
      fetch('/admin/ingredient/list')
        .then(r=>r.json())
        .then(d=>{ document.getElementById('ingredients-list').textContent = JSON.stringify(d, null, 2); });
    }
    
    function createIngredient(){
      const {u,p} = creds();
      const body = {
        username: u,
        password: p,
        name: document.getElementById('ingr-name').value,
        costCents: parseInt(document.getElementById('ingr-cost').value||'0',10),
        hasMeat: document.getElementById('ingr-meat').checked,
        hasAnimalProducts: document.getElementById('ingr-animal').checked,
      };
      fetch('/admin/ingredient/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) })
        .then(r=>r.ok?r.json():r.text())
        .then(d=>{ alert(typeof d==='string'?d:('Created '+d.Ingr?.Name||d.name)); listIngredients(); });
    }
    
    function deleteIngredient(){
      const {u,p} = creds();
      const id = document.getElementById('ingr-del-id').value;
      fetch('/admin/ingredient/delete?id='+encodeURIComponent(id), { method:'DELETE', headers:{'X-Username':u,'X-Password':p} })
        .then(r=>{ if(r.ok){ alert('Deleted'); listIngredients(); } else { return r.text().then(t=>{ throw new Error(t); }); } })
        .catch(e=>alert(e.message));
    }
    
    // Pizzas Management (existing code)
    function listPizzas(){
      fetch('/admin/pizza/list')
        .then(r=>r.json())
        .then(d=>{ document.getElementById('pizzas-list').textContent = JSON.stringify(d, null, 2); });
    }
    
    function createPizza(){
      const {u,p} = creds();
      const name = document.getElementById('pizza-name').value;
      const ingredients = (document.getElementById('pizza-ingredients').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      fetch('/admin/pizza/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p, name, ingredients }) })
        .then(r=>r.ok?r.json():r.text())
        .then(d=>{ alert(typeof d==='string'?d:('Created '+(d.Name||name))); listPizzas(); });
    }
    
    function deletePizza(){
      const {u,p} = creds();
      const id = document.getElementById('pizza-del-id').value;
      fetch('/admin/pizza/delete?id='+encodeURIComponent(id), { method:'DELETE', headers:{'X-Username':u,'X-Password':p} })
        .then(r=>{ if(r.ok){ alert('Deleted'); listPizzas(); } else { return r.text().then(t=>{ throw new Error(t); }); } })
        .catch(e=>alert(e.message));
    }

    // Load initial data
    loadUsers();
  </script>
  </center>
</body>
</html>