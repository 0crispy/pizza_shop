<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Pizza Shop</title>
</head>
<body>
  <center>
    <h1>Welcome to Pizza Shop</h1>
    <p><i>Create your account</i></p>
    <hr>

    <h2>Register</h2>

    <form>
      <table>
        <tr><td><b>Username:</b></td></tr>
        <tr><td><input type="text" id="username" name="username" required></td></tr>

        <tr><td><b>Password:</b></td></tr>
        <tr><td><input type="password" id="password" name="password" required></td></tr>

        <tr><td><b>Your name:</b></td></tr>
        <tr><td><input type="text" id="name" name="name" required></td></tr>

        <tr><td><b>Your gender:</b></td></tr>
        <tr><td>
          <input type="radio" id="male" name="gender" value="Male" required>
          <label for="male">Male</label>
          <input type="radio" id="female" name="gender" value="Female">
          <label for="female">Female</label>
          <input type="radio" id="nonbinary" name="gender" value="Non-binary">
          <label for="nonbinary">Non-binary</label><br>
          <input type="radio" id="none" name="gender" value="None">
          <label for="none">Prefer not to say</label>
          <input type="radio" id="other" name="gender" value="Other">
          <label for="other">Other:</label>
          <input type="text" id="other_gender" name="other_gender">
        </td></tr>

        <tr><td><b>Select your birth date:</b></td></tr>
        <tr><td><input type="date" id="birth_date" name="birth_date"></td></tr>
        <tr><td>
          <input type="checkbox" id="no_birth_date" name="no_birth_date" value="true">
          <label for="no_birth_date">I do not want to share my birth date</label>
        </td></tr>

        <tr><td><b>Your address:</b></td></tr>
        <tr><td><input type="text" id="address" name="address" required></td></tr>

        <tr><td><b>Your postal code:</b></td></tr>
        <tr><td><input type="text" id="postcode" name="postcode" required></td></tr>

        <tr><td><p id="error"></p></td></tr>

        <tr><td><button type="submit" onclick="login(event)">Register</button></td></tr>
      </table>
    </form>

    <p>Already have an account? <a href="/login">Login here</a></p>
  </center>


<script>

    const birthDateCheckbox = document.getElementById("no_birth_date");
    const birthDateInput = document.getElementById("birth_date");
    birthDateCheckbox.addEventListener("change", () => {
        birthDateInput.disabled = birthDateCheckbox.checked;
        if (birthDateCheckbox.checked){
            alert("Your birth date is used for special birthday promotions. If you skip it, you may miss out!");
        }
    });

    const genderRadios = document.getElementsByName("gender");
    const otherGenderInput = document.getElementById("other_gender");
    function updateOtherInput() {
        const otherSelected = Array.from(genderRadios).some(r => r.checked && r.value === "Other");
        otherGenderInput.disabled = !otherSelected;
        if (!otherSelected) otherGenderInput.value = "";
    }
    genderRadios.forEach(radio => {
        radio.addEventListener("change", updateOtherInput);
    });
    updateOtherInput();

    function login(event){
        event.preventDefault();

        var usernameInput = document.getElementById("username");
        var passwordInput = document.getElementById("password");
        var nameInput = document.getElementById("name");
        var gender = getGender();
        var birthDateInput = document.getElementById("birth_date");
        var noBirthDate = document.getElementById("no_birth_date");
        var addressInput = document.getElementById("address");
        var postcodeInput = document.getElementById("postcode");

        var sendData = {
            username: usernameInput.value,
            password: passwordInput.value,
            name: nameInput.value,
            gender: gender,
            birthDate: birthDateInput.value,
            noBirthDate: noBirthDate.checked,
            address: addressInput.value,
            postcode: postcodeInput.value
        };

        fetch("/register", {
            method: "POST",
            headers: {
            "Content-Type": "application/json"
            },
            body: JSON.stringify(sendData)
        })
        .then(response => response.json())
        .then(data =>{
            if (data.ok){
                sessionStorage.setItem("username", usernameInput.value);
                sessionStorage.setItem("password", passwordInput.value);
                window.location = "/home";
            }
            else{
                var errorText = document.getElementById("error");
                errorText.innerHTML = data.msg;
            }
        });
    }

    
    function getGender() {
        const radios = document.getElementsByName("gender");
        let selected = null;

        for (const radio of radios) {
            if (radio.checked) {
                selected = radio.value;
                break;
            }
        }
        if (selected === "Other") {
            const otherInput = document.getElementById("other_gender").value;
            if (otherInput.trim() !== "") {
                selected = otherInput.trim();
            }
        }
        return selected;
    }

</script>
</body>
</html>