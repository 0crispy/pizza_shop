<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shopping Cart - Pizza Shop</title>
  <script>
    function logout(){
      try {
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('password');
      } catch(_) {}
      window.location = '/login?logout=1';
    }

    async function ensureAuthAndSetupNav(){
      const u = sessionStorage.getItem('username');
      const p = sessionStorage.getItem('password');
      if (!u || !p) { window.location = '/login'; return; }
      document.getElementById('connected_as').textContent = 'Connected as: ' + u + '.';
      try {
        const r = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p}) });
        const data = await r.json();
        if (!data.ok) { window.location = '/login'; return; }
        if (data.isAdmin) {
          const adminLink = document.getElementById('admin-link');
          if (adminLink) adminLink.style.display = 'inline-block';
        }
      } catch {
        // If the check fails, we silently keep user on page
      }
      updateCartCount();
      loadExtraItems();
      checkBirthdayPromotion(); // Check for birthday discount
    }

    async function checkBirthdayPromotion() {
      try {
        const response = await fetch('/api/check-birthday');
        const data = await response.json();
        
        if (data.ok && data.is_birthday && !data.already_used) {
          // Show birthday message
          const discountInfo = document.getElementById('discount-info');
          discountInfo.innerHTML = `<p style="color: #4CAF50; font-weight: bold;">${data.message}</p>`;
          discountInfo.style.display = 'block';
          
          // Auto-apply the birthday discount
          sessionStorage.setItem('discountCode', data.code);
          sessionStorage.setItem('discountPercent', 0); // Birthday is special, not percentage-based
          document.getElementById('discount-code').value = data.code;
          loadCart(); // Reload to show discount
        } else if (data.ok && data.is_birthday && data.already_used) {
          // Already used birthday discount
          const discountInfo = document.getElementById('discount-info');
          discountInfo.innerHTML = `<p style="color: #ff9800;">${data.message}</p>`;
          discountInfo.style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to check birthday:', error);
      }
    }

    async function loadExtraItems() {
      try {
        const response = await fetch('/extra-items/list');
        const items = await response.json();
        
        const desserts = items.filter(item => item.category === 'DESSERT');
        const drinks = items.filter(item => item.category === 'DRINK');
        
        displayExtraItems('desserts-list', desserts);
        displayExtraItems('drinks-list', drinks);
      } catch (error) {
        console.error('Failed to load extra items:', error);
      }
    }

    function displayExtraItems(containerId, items) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.innerHTML = `
          <p><b>${item.name}</b> - $${item.price.toFixed(2)}<br>
          <small>${item.description || ''}</small><br>
          <button onclick="addExtraItemToCart(${item.id}, '${item.name}', ${item.price})">Add</button></p>
        `;
        container.appendChild(div);
      });
    }

    function addExtraItemToCart(id, name, price) {
      let cart = JSON.parse(localStorage.getItem('pizzaCart') || '[]');
      
      const existingItem = cart.find(item => item.id === id && item.type === 'extra');
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ id, name, price, quantity: 1, type: 'extra' });
      }
      
      localStorage.setItem('pizzaCart', JSON.stringify(cart));
      updateCartCount();
      loadCart();
      alert(name + ' added to cart!');
    }

    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('pizzaCart') || '[]');
      const tbody = document.querySelector('#cart-table tbody');
      tbody.innerHTML = '';
      
      if (cart.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Your cart is empty</td></tr>';
        document.getElementById('subtotal').textContent = '$0.00';
        document.getElementById('discount-amount').textContent = '$0.00';
        document.getElementById('total').textContent = '$0.00';
        return;
      }
      
      let subtotal = 0;
      cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${item.name}</b></td>
          <td align="right">$${item.price.toFixed(2)}</td>
          <td align="center">
            <button onclick="updateQuantity(${item.id}, ${item.quantity - 1}, '${item.type || 'pizza'}')">-</button>
            ${item.quantity}
            <button onclick="updateQuantity(${item.id}, ${item.quantity + 1}, '${item.type || 'pizza'}')">+</button>
          </td>
          <td align="right">$${itemTotal.toFixed(2)}</td>
          <td align="center"><button onclick="removeFromCart(${item.id}, '${item.type || 'pizza'}')">Remove</button></td>
        `;
        tbody.appendChild(tr);
      });
      
      const discountCode = sessionStorage.getItem('discountCode');
      const discountPercent = parseInt(sessionStorage.getItem('discountPercent') || '0');
      
      let discountAmount = 0;
      let discountMessage = '';
      
      if (discountCode === 'BIRTHDAY') {
        // Birthday discount: calculate cheapest pizza + cheapest drink
        const pizzas = cart.filter(item => (item.type || 'pizza') === 'pizza');
        const drinks = cart.filter(item => item.type === 'extra' && item.name.toLowerCase().includes('water') || 
                                           item.name.toLowerCase().includes('cola') || 
                                           item.name.toLowerCase().includes('sprite') ||
                                           item.name.toLowerCase().includes('fanta') ||
                                           item.name.toLowerCase().includes('juice') ||
                                           item.name.toLowerCase().includes('tea') ||
                                           item.name.toLowerCase().includes('lemonade') ||
                                           item.name.toLowerCase().includes('coffee'));
        
        if (pizzas.length > 0) {
          const cheapestPizza = pizzas.reduce((min, p) => p.price < min.price ? p : min);
          discountAmount += cheapestPizza.price;
        }
        
        if (drinks.length > 0) {
          const cheapestDrink = drinks.reduce((min, d) => d.price < min.price ? d : min);
          discountAmount += cheapestDrink.price;
        } else {
          // Add cheapest drink price (Water = $1.50) to show in discount
          discountAmount += 1.50;
        }
        
        discountMessage = 'ðŸŽ‰ Birthday Special: Free cheapest pizza + free drink! ðŸŽ‰';
      } else if (discountPercent > 0) {
        discountAmount = (subtotal * discountPercent) / 100;
        discountMessage = `Discount code "${discountCode}" applied (${discountPercent}% off)`;
      }
      
      const total = subtotal - discountAmount;

      document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('discount-amount').textContent = discountAmount > 0 ? '-$' + discountAmount.toFixed(2) : '$0.00';
      document.getElementById('total').textContent = '$' + total.toFixed(2);
      
      if (discountCode) {
        document.getElementById('discount-info').innerHTML = discountMessage;
        document.getElementById('discount-code').value = discountCode;
      }
    }

    async function applyDiscount() {
      const code = document.getElementById('discount-code').value.trim().toUpperCase();
      console.log('Applying discount code:', code);
      
      if (!code) {
        alert('Please enter a discount code');
        return;
      }

      try {
        const response = await fetch('/api/validate-discount?code=' + encodeURIComponent(code));
        const data = await response.json();
        console.log('Discount validation response:', data);
        
        if (data.ok && data.valid) {
          sessionStorage.setItem('discountCode', code);
          sessionStorage.setItem('discountPercent', data.discount_percentage || '0');
          
          if (code === 'BIRTHDAY') {
            document.getElementById('discount-info').innerHTML = '<span style="color: #4CAF50;">ðŸŽ‰ Birthday discount applied! Free cheapest pizza + 1 free drink! ðŸŽ‰</span>';
          } else if (data.discount_percentage > 0) {
            document.getElementById('discount-info').innerHTML = `<span style="color: #4CAF50;">Discount code "${code}" applied (${data.discount_percentage}% off)</span>`;
          } else {
            document.getElementById('discount-info').innerHTML = `<span style="color: #4CAF50;">${data.message}</span>`;
          }
          
          loadCart();
          alert(data.message || `Discount code applied successfully!`);
        } else {
          alert(data.message || 'Invalid or inactive discount code');
        }
      } catch (err) {
        console.error('Error applying discount:', err);
        alert('Error validating discount code: ' + err.message);
      }
    }

    function removeDiscount() {
      sessionStorage.removeItem('discountCode');
      sessionStorage.removeItem('discountPercent');
      document.getElementById('discount-code').value = '';
      document.getElementById('discount-info').textContent = '';
      loadCart();
    }

    function updateQuantity(id, newQuantity, type = 'pizza') {
      let cart = JSON.parse(localStorage.getItem('pizzaCart') || '[]');
      
      if (newQuantity <= 0) {
        removeFromCart(id, type);
        return;
      }
      
      const item = cart.find(item => item.id === id && (item.type || 'pizza') === type);
      if (item) {
        item.quantity = newQuantity;
        localStorage.setItem('pizzaCart', JSON.stringify(cart));
        loadCart();
        updateCartCount();
      }
    }

    function removeFromCart(id, type = 'pizza') {
      let cart = JSON.parse(localStorage.getItem('pizzaCart') || '[]');
      cart = cart.filter(item => !(item.id === id && (item.type || 'pizza') === type));
      localStorage.setItem('pizzaCart', JSON.stringify(cart));
      loadCart();
      updateCartCount();
    }

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('pizzaCart') || '[]');
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartLink = document.getElementById('cart-link');
      if (cartLink) {
        cartLink.textContent = 'Cart (' + count + ')';
      }
    }

    async function checkout() {
      const cart = JSON.parse(localStorage.getItem('pizzaCart') || '[]');
      
      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      
      const deliveryAddress = document.getElementById('delivery-address').value.trim();
      const postalCode = document.getElementById('postal-code').value.trim();
      
      if (!deliveryAddress || !postalCode) {
        alert('Please enter delivery address and postal code');
        return;
      }
      
      const username = sessionStorage.getItem('username');
      const password = sessionStorage.getItem('password');
      const discountCode = sessionStorage.getItem('discountCode');
      
      const cartItems = cart.map(item => ({
        id: item.id,
        quantity: item.quantity,
        type: item.type || 'pizza' // Include type, default to 'pizza' if not set
      }));
      
      try {
        const response = await fetch('/order/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            password: password,
            delivery_address: deliveryAddress,
            postal_code: postalCode,
            cart_items: cartItems,
            discount_code: discountCode || null
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          localStorage.removeItem('pizzaCart');
          sessionStorage.removeItem('discountCode');
          sessionStorage.removeItem('discountPercent');
          window.location.href = '/order-confirmation?order_id=' + data.order_id;
        } else {
          alert('Error: ' + (data.error || 'Failed to place order'));
        }
      } catch (err) {
        alert('Error placing order: ' + err.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      ensureAuthAndSetupNav();
      loadCart();
    });
  </script>
</head>
<body>
<center>
  <nav>
    <a href="/home">Home</a> |
    <a href="/account">Account</a> |
    <a id="admin-link" href="/admin" style="display:none;">Admin</a>
    <a id="cart-link" href="/cart"><b>Cart (0)</b></a> |
    <a href="#" onclick="logout(); return false;">Logout</a>
  </nav>
  <hr>
  <h1>Shopping Cart</h1>
  <p id="connected_as"><i>Connected as: ?</i></p>
  
  <h2>Add Items</h2>
  <table width="70%">
    <tr>
      <td width="50%" valign="top">
        <h3>Desserts</h3>
        <div id="desserts-list"></div>
      </td>
      <td width="50%" valign="top">
        <h3>Drinks</h3>
        <div id="drinks-list"></div>
      </td>
    </tr>
  </table>
  <hr width="70%">

  <h2>Your Cart</h2>
  <table id="cart-table" border="1" cellpadding="8" cellspacing="0" width="70%">
    <thead>
      <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Total</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
  <br>
  <h3>Subtotal: <span id="subtotal">$0.00</span></h3>
  <h3>Discount: <span id="discount-amount">$0.00</span></h3>
  <h3>Total: <span id="total">$0.00</span></h3>
  <hr width="70%">
  
  <h2>Discount Code</h2>
  <p>
    <input type="text" id="discount-code" placeholder="Enter discount code" size="20">
    <button onclick="applyDiscount()">Apply</button>
    <button onclick="removeDiscount()">Remove</button>
  </p>
  <p id="discount-info" style="color: green; font-weight: bold;"></p>
  <hr width="70%">
  
  <h2>Delivery Information</h2>
  <table>
    <tr>
      <td align="right">Delivery Address:</td>
      <td><input type="text" id="delivery-address" size="40"></td>
    </tr>
    <tr>
      <td align="right">Postal Code:</td>
      <td><input type="text" id="postal-code" size="15"></td>
    </tr>
  </table>
  <br>
  <button onclick="checkout()">Proceed to Checkout</button>
</center>
</body>
</html>